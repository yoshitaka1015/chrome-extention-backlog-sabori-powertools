{
  "version": 3,
  "sources": ["../../../src/content/topbar/viewportShimMain.ts"],
  "sourcesContent": ["const VIEWPORT_SHIM_EVENT = \"backlogManagerViewportShim\";\nconst FLAG = \"__backlogViewportShimLoaded\";\nconst DEFAULT_OFFSET = 0;\nconst MIN_DELTA_BEFORE_SHRINK = 16; // \u3053\u306E\u5DEE\u5206\u672A\u6E80\u306A\u3089\u7E2E\u3081\u306A\u3044\n\ndeclare global {\n  interface Window {\n    [FLAG]?: boolean;\n  }\n}\n\nif (!window[FLAG]) {\n  window[FLAG] = true;\n\n  const originalInner = Object.getOwnPropertyDescriptor(window, \"innerHeight\");\n  const originalClient = Object.getOwnPropertyDescriptor(document.documentElement, \"clientHeight\");\n  const visualViewport = window.visualViewport;\n  const originalVisualHeight = visualViewport\n    ? Object.getOwnPropertyDescriptor(Object.getPrototypeOf(visualViewport), \"height\")\n    : undefined;\n\n  let currentOffset = DEFAULT_OFFSET;\n\n  const getBaseInnerHeight = () => {\n    const visual = visualViewport && typeof visualViewport.height === \"number\" ? visualViewport.height : 0;\n    const inner = typeof window.innerHeight === \"number\" ? window.innerHeight : 0;\n    const original = originalInner?.get\n      ? (() => {\n          try {\n            return originalInner.get.call(window) as number;\n          } catch {\n            return 0;\n          }\n        })()\n      : 0;\n    const client = typeof document.documentElement.clientHeight === \"number\" ? document.documentElement.clientHeight : 0;\n    return Math.max(visual, inner, original, client, 0);\n  };\n\n  const safeDefine = (\n    target: Window | HTMLElement,\n    key: \"innerHeight\" | \"clientHeight\",\n    getter: () => number,\n    original?: PropertyDescriptor\n  ) => {\n    if (original && original.configurable === false) {\n      return;\n    }\n    try {\n      Object.defineProperty(target, key, {\n        configurable: true,\n        get: getter\n      });\n    } catch {\n      // ignore\n    }\n  };\n\n  const safeDefineVisualHeight = (getter: () => number) => {\n    if (!visualViewport) {\n      return;\n    }\n    try {\n      Object.defineProperty(visualViewport, \"height\", {\n        configurable: true,\n        get: getter\n      });\n    } catch {\n      // ignore\n    }\n  };\n\n  const applyShim = () => {\n    const baseHeight = getBaseInnerHeight();\n    if (!Number.isFinite(baseHeight) || baseHeight <= 0) {\n      restoreShim();\n      return;\n    }\n    if (baseHeight <= currentOffset + MIN_DELTA_BEFORE_SHRINK) {\n      restoreShim();\n      return;\n    }\n    const nextHeight = Math.max(0, Math.floor(baseHeight - currentOffset));\n    safeDefine(window, \"innerHeight\", () => nextHeight, originalInner);\n    safeDefine(document.documentElement, \"clientHeight\", () => nextHeight, originalClient);\n    safeDefineVisualHeight(() => nextHeight);\n  };\n\n  const restoreShim = () => {\n    try {\n      if (originalInner?.configurable) {\n        Object.defineProperty(window, \"innerHeight\", originalInner);\n      }\n      if (originalClient?.configurable) {\n        Object.defineProperty(document.documentElement, \"clientHeight\", originalClient);\n      }\n      if (visualViewport && originalVisualHeight?.configurable) {\n        Object.defineProperty(Object.getPrototypeOf(visualViewport), \"height\", originalVisualHeight);\n      }\n    } catch {\n      // ignore\n    }\n  };\n\n  const updateOffset = (nextOffset: number) => {\n    currentOffset = Math.max(0, Math.round(nextOffset));\n    if (currentOffset > 0) {\n      applyShim();\n    } else {\n      restoreShim();\n    }\n    try {\n      window.dispatchEvent(new Event(\"resize\"));\n    } catch {\n      // ignore\n    }\n  };\n\n  // \u521D\u671F\u30AA\u30D5\u30BB\u30C3\u30C8\u306F 0\u3001\u30A4\u30D9\u30F3\u30C8\u53D7\u4FE1\u6642\u306B\u4E0A\u66F8\u304D\n  updateOffset(DEFAULT_OFFSET);\n\n  window.addEventListener(VIEWPORT_SHIM_EVENT, (event: Event) => {\n    const detail = (event as CustomEvent).detail;\n    const nextOffset = detail && typeof detail.offset === \"number\" ? detail.offset : 0;\n    updateOffset(nextOffset);\n  });\n}\n"],
  "mappings": "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",
  "names": []
}
