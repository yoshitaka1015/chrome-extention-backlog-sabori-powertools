# 上部バー＋統合サイドパネル 要件定義（Draft v0.1)

最終更新: 2025-11-01 (Asia/Tokyo)

---

## 0. 目的 / 背景

- 「**上部バー（Siri風ビジョンスペース）**」と「**統合サイドパネル（ガント＋起票＋ChatGPT連携）**」を組み合わせ、
  - 直近タスクの“見逃し防止”
  - 長文からの“素早い要約→起票”
  - プロジェクト横断の“2週間見通し” を同時に満たす日常運用を実現する。
- 外部AI **APIは未使用**。ChatGPTは**ブラウザUI**を人が開く前提で連携（結果はJSONで受領）。
- Slack APIは使用しない。Backlog API v2とChrome拡張（Manifest v3）で完結。

---

## 1. スコープ

- 対象: Backlog（クラウド）利用の個人ユーザー。
- ブラウザ: Google Chrome（Manifest v3, Side Panel対応）。
- タイムゾーン: Asia/Tokyo 固定。

---

## 2. 画面構成（全体像）

- **上部バー（ページ最上部にオーバーレイ表示）**
  - 本日/明日の自分担当・未完了タスクを“**件名バッジ**”で横並び表示。
  - バッジはマウスホイールで**左右スライド**（オーバーフロー時のみ）。
  - 右端に\*\*＋ボタン\*\*（クイック起票）。
- **統合サイドパネル**（A＋B＋D）
  - **上**: ガント（2週間）
  - **中**: チケット作成ウィンドウ（Backlog起票フォーム）
  - **下**: ChatGPT連携ビュー（JSON受信プレビュー）
  - 仕切りバーで比率調整（最小200px）。
- 起動: 拡張アイコン/ショートカット（例: Alt+G）。サイドパネルは**タブ切替でも維持**（ピン留め前提）。

---

## 3. 上部バー（Siri風ビジョンスペース）

**3.1 表示**

- セクション: **本日のタスク / 明日のタスク** の2列。
- 各セクションは“**件名バッジ**”を横方向に並べる。
- バッジ内容: `issue.summary`（長い場合はellipsis）。ツールチップに**プロジェクト/カテゴリー/期限**。
- 強調: 期限超過=赤、当日=オレンジ、明日=黄色、期限未設定=グレー。

**3.2 スクロール/操作**

- オーバーフロー時のみ**スライドバー/インジケータ**を表示。
- **マウスホイールの縦スクロールを横移動に変換**（`wheel` → `scrollLeft += deltaY`）。
- 件数が少ない場合は**スライドなし**で全件表示。
- バッジクリックで**Backlog課題詳細を新規タブ**で開く。

**3.3 クイック起票（＋ボタン）**

- 選択テキストがあれば本文に下書き。なければ**クリップボード**を本文に下書き（許可済み時）。
- その場の**インページ・モーダル**で **プロジェクト/カテゴリー/開始日/期限日** を編集して保存（担当=自分）。

**3.4 データ条件/更新**

- 対象: **自分担当**かつ**未完了**の課題。
- 範囲: **今日/明日（直近2日）**。並びは**期限日昇順**、未設定は末尾。
- 更新: 初回/一定間隔（10–15分）/手動リロード。

**3.5 互換/制御**

- 表示ON/OFF、対象ドメインのホワイト/ブラックリスト、バー高さのプリセット（コンパクト/標準）。
- SPA対策: URL変化時の再描画。`chrome://*` など一部ページは非対象。

---

## 4. 統合サイドパネル（A＋B＋D）

**4.1 上: ガント（Aそのまま）**

- 自分担当・未完了を**今日〜14日後**で可視化。
- **プロジェクト→カテゴリー**2段グループ、開始未設定は1日バー/マイルストーン、期限未設定は別枠。
- Todayライン、週末シェーディング、ツールチップ、課題へのリンク。

**4.2 中: チケット作成ウィンドウ（Bを拡張）**

- フィールド: プロジェクト、カテゴリー（プロジェクト連動）、種別、優先度、担当（自分既定）、開始日、期限日、タイトル、本文。
- 入力元: 上部バーの＋/右クリック起票/手入力。**ChatGPT受信JSON**で自動反映。
- 操作: **チケットを作成**（単票） / **複数チケットを作成**（JSONの`tickets[]`分を一括POST）。
- バリデーション: 期限日<開始日で警告。必須 `projectId/issueTypeId/priorityId/summary`。

**4.3 下: ChatGPT連携ビュー（Dの運用）**

- 方針: **APIは使わず**、ChatGPTの**新規タブ**を開いて定型プロンプト＋原文を投入（自動貼付は任意・既定OFF）。
- DOM監視で**JSONのみ抽出**→拡張へ送信→**中段に反映**。
- ステータス（起動/貼付待ち/応答待ち/JSON受信）、整形プレビュー、履歴（最新5件）、再送/反映ボタン。

**4.4 JSONスキーマ（例）**

```json
{
  "tickets": [
    {
      "summary": "短い件名",
      "description": "本文（箇条書き可）",
      "startDate": "YYYY-MM-DD or null",
      "dueDate": "YYYY-MM-DD or null",
      "category": "カテゴリ名 or null",
      "priority": "low|normal|high|urgent|null"
    }
  ]
}
```

- 最大10件。超過は警告。カテゴリ名→`categoryId`は設定でマッピング。日付不正は空＋警告。パース不可はフォールバック（タイトル=先頭行、本文=原文、日付空）。

**4.5 フロー**

1. 上部ガントで直近2週間を確認。
2. 中段に原文（上部バー/選択/クリップボード）を置く。
3. **ChatGPTで要約** → 新規タブ起動 → JSON受信。
4. **反映** → **単票/複数作成**でBacklogへPOST。

---

## 5. データ取得/作成 設計（Backlog API）

- 一覧: `GET /api/v2/issues`（`assigneeId=自分`, `statusId[]=未完`, `sort=dueDate&order=asc`）
  - ガント: クライアントで**14日**に絞る。
  - 上部バー: **今日/明日**に絞る（必要に応じクライアントフィルタ）。
- マスタ: プロジェクト/カテゴリー/種別/優先度/ユーザーを起動時に取得しキャッシュ。
- 作成: `POST /api/v2/issues`（必須 `projectId/summary/issueTypeId/priorityId`。任意 `description/startDate/dueDate/categoryId[]/assigneeId`）。

---

## 6. 権限 / 構成

- Permissions: `sidePanel`, `action`, `commands`, `storage`, `notifications`, `activeTab`, `contextMenus`, `clipboardRead`, `clipboardWrite`, `scripting`, `webNavigation`。
- Host permissions:
  - Backlog: `https://*.backlog.com/*`, `https://*.backlog.jp/*`
  - ChatGPT: `https://chat.openai.com/*` または `https://chatgpt.com/*`
  - 上部バー: **必要なサイトに限定**して `matches` を設定（推奨: ユーザー選択の**optional\_host\_permissions**）。
- Content scripts:
  - 上部バーの挿入（Shadow DOM/position\:fixed/top:0）。
  - ChatGPTドメインで**JSON抽出→拡張へpostMessage**。

---

## 7. 起動方式

- サイドパネル: 拡張アイコン/キーボードショートカット（Alt+G 例）でトグル。ピン留めで**タブ切替でも維持**。
- 上部バー: オプションからON/OFF、対象サイト/高さプリセットを設定。ページ再読込で反映。
- クイック起票: 上部バーの\*\*＋\*\*、または右クリック「Backlogへ送る」。

---

## 8. 受け入れ基準

**上部バー**

-

**統合サイドパネル**

-

---

## 9. リスク / 前提

- ChatGPTのDOM仕様変更で抽出が壊れる可能性 → **手動貼付フォールバック**を常備。
- 上部バーはサイトCSSと衝突しやすい → **Shadow DOM**で隔離し、z-index/高さを調整。
- カテゴリー/種別はプロジェクトごとに異なる → プロジェクト変更時の再取得必須。
- 大量課題時はページング/スケルトンで体感速度を担保。

---

## 10. 将来拡張（任意）

- 自然言語日時の正規化（「明日/来週/月末」）。
- 期限逼迫/未設定/更新停滞での**リスク色分け**強化（上部バー＋ガント）。
- **ネイティブメッセージング**経由でOS内蔵LLM（Windows: Phi Silica / macOS: Foundation Models）を使う完全ローカル要約モード。

